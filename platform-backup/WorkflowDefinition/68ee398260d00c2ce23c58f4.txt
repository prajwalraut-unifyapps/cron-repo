{
	"appsUsed":[
		
	],
	"createdTime":1760442754488,
	"deleted":false,
	"edges":[
		{
			"fromNodeId":"n_5pCa4",
			"priority":0,
			"skip":false,
			"toNodeId":"n_ET0k2",
			"type":"next"
		},
		{
			"fromNodeId":"n_ET0k2",
			"priority":0,
			"skip":false,
			"toNodeId":"n_HxMj7",
			"type":"next"
		},
		{
			"fromNodeId":"n_HxMj7",
			"priority":0,
			"skip":false,
			"toNodeId":"n_Sy0Hw",
			"type":"next"
		},
		{
			"fromNodeId":"n_Sy0Hw",
			"priority":0,
			"skip":false,
			"toNodeId":"n_3E5R1",
			"type":"next"
		},
		{
			"fromNodeId":"n_3E5R1",
			"name":"yes",
			"priority":0,
			"skip":false,
			"toNodeId":"n_7xsRp",
			"type":"if"
		},
		{
			"fromNodeId":"n_7xsRp",
			"name":"error",
			"priority":0,
			"skip":false,
			"toNodeId":"_buXRg",
			"type":"error"
		},
		{
			"fromNodeId":"n_7xsRp",
			"priority":0,
			"skip":false,
			"toNodeId":"n_NWFBG",
			"type":"next"
		},
		{
			"fromNodeId":"_buXRg",
			"priority":0,
			"skip":false,
			"toNodeId":"n_NWFBG",
			"type":"next"
		},
		{
			"fromNodeId":"n_NWFBG",
			"name":"error",
			"priority":0,
			"skip":false,
			"toNodeId":"_ykicF",
			"type":"error"
		},
		{
			"fromNodeId":"n_NWFBG",
			"priority":0,
			"skip":false,
			"toNodeId":"n_cJWiB",
			"type":"next"
		},
		{
			"fromNodeId":"_ykicF",
			"priority":0,
			"skip":false,
			"toNodeId":"n_cJWiB",
			"type":"next"
		},
		{
			"fromNodeId":"n_cJWiB",
			"name":"yes",
			"priority":0,
			"skip":false,
			"toNodeId":"n_q1A6h",
			"type":"if"
		},
		{
			"fromNodeId":"n_cJWiB",
			"name":"no",
			"priority":0,
			"skip":false,
			"toNodeId":"_GOWnv",
			"type":"next"
		},
		{
			"fromNodeId":"n_3E5R1",
			"name":"no",
			"priority":0,
			"skip":false,
			"toNodeId":"n_9hMgd",
			"type":"next"
		}
	],
	"id":"68ee398260d00c2ce23c58f4",
	"lastModifiedBy":161958,
	"lcName":"validate azure ad token",
	"modifiedTime":1760442784995,
	"name":"Validate Azure Ad Token",
	"nodes":[
		{
			"context":{
				"appName":"callables",
				"resourceVersion":1004,
				"resourceName":"callables_from_interface"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_6Puoh-1",
			"id":"n_5pCa4",
			"index":1,
			"inputs":{},
			"skip":false,
			"subTitle":"Callable",
			"title":"Trigger interface",
			"trigger":{
				"type":"CALLABLE"
			},
			"type":"START"
		},
		{
			"context":{
				"appName":"code_by_unifyapps",
				"resourceVersion":5,
				"resourceName":"code_by_unifyapps_groovy",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_6Puoh-1",
			"id":"n_ET0k2",
			"index":2,
			"inputs":{
				"output":{
					"type":"object",
					"additionalProperties":false,
					"required":[],
					"properties":{
						"authorization":{
							"type":"string",
							"title":"Authorization"
						}
					}
				},
				"input":{
					"type":"object",
					"additionalProperties":false,
					"required":[],
					"properties":{
						"headers":{
							"type":"object",
							"properties":{},
							"additionalProperties":false,
							"title":"Headers"
						}
					}
				},
				"code":"def authValue = headers?.requestHeaders?.authorization?.getAt(0)\r\ndef token = \"\"\r\nif (authValue) {\r\n    token = authValue.replaceAll(\"Bearer \", \"\")\r\n}\r\nreturn [\"authorization\": token ]",
				"compile_static":false,
				"captureStdOutput":false,
				"parameters":{
					"headers":"{{ n_olwxh.outputs.request }}"
				}
			},
			"options":{
				"bulkheadConfig":{
					"enabled":false,
					"maxLeaseTimeUnit":"SECONDS",
					"maxWaitDurationUnit":"SECONDS"
				},
				"businessHoursConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"cacheConfig":{
					"enabled":false,
					"usagePolicy":"ALWAYS"
				},
				"circuitBreakerConfig":{
					"enabled":false,
					"slidingWindowType":"COUNT_BASED"
				},
				"disableLogging":true,
				"enabledForReExecution":false,
				"hookConfig":{
					"enabled":false,
					"postHooks":[
						
					],
					"preHooks":[
						
					]
				},
				"logConfig":{
					"enabled":false,
					"logPolicies":[
						
					]
				},
				"rateLimitConfig":{
					"enabled":false,
					"unit":"MINUTES",
					"waitForNextWindow":false
				},
				"retryConfig":{
					"backOffFactor":null,
					"captureRetries":false,
					"enabled":false
				},
				"stepError":"STOP",
				"telemetryConfig":{
					"enableTelemetry":false,
					"metricConfigs":[
						
					]
				}
			},
			"skip":false,
			"subTitle":"Code by UnifyApps",
			"title":"Execute Groovy code",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"variable_by_unifyapps",
				"resourceVersion":5,
				"resourceName":"variable_by_unifyapps_create_variables",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_6Puoh-1",
			"id":"n_HxMj7",
			"index":3,
			"inputSchema":{
				"type":"SCHEMA_AND_LAYOUT",
				"dynamic":false,
				"layout":{},
				"schema":{
					"additionalProperties":false,
					"type":"object",
					"properties":{
						"response":{
							"type":"object",
							"properties":{
								"message":{
									"type":"string",
									"title":"Message"
								}
							},
							"additionalProperties":false,
							"title":"Response",
							"required":[]
						}
					},
					"required":[]
				}
			},
			"inputs":{
				"response":{
					"message":"JWT Validation Failed"
				}
			},
			"outputSchema":{
				"dynamic":false,
				"schema":{
					"additionalProperties":false,
					"type":"object",
					"properties":{
						"response":{
							"type":"object",
							"properties":{
								"message":{
									"type":"string",
									"title":"Message"
								}
							},
							"additionalProperties":false,
							"title":"Response",
							"required":[]
						}
					},
					"required":[]
				}
			},
			"skip":false,
			"subTitle":"Variable by UnifyApps",
			"title":"Create variables",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"variable_by_unifyapps",
				"resourceVersion":869,
				"resourceName":"variable_by_unifyapps_create_variables",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_6Puoh-1",
			"id":"n_Sy0Hw",
			"index":4,
			"inputSchema":{
				"type":"SCHEMA_AND_LAYOUT",
				"dynamic":false,
				"layout":{},
				"schema":{
					"additionalProperties":false,
					"type":"object",
					"properties":{
						"tenantId":{
							"type":"string",
							"title":"Tenant Id"
						}
					},
					"required":[
						"tenantId"
					]
				}
			},
			"inputs":{
				"tenantId":"0d85160c-5899-44ca-acc8-db1501b993b6"
			},
			"outputSchema":{
				"dynamic":false,
				"schema":{
					"additionalProperties":false,
					"type":"object",
					"properties":{
						"tenantId":{
							"type":"string",
							"title":"Tenant Id"
						}
					},
					"required":[
						"tenantId"
					]
				}
			},
			"skip":false,
			"subTitle":"Variable by UnifyApps",
			"title":"Create variables",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"if_else",
				"resourceVersion":5,
				"resourceName":"if_else_condition",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_6Puoh-1",
			"id":"n_3E5R1",
			"index":5,
			"inputs":{
				"filters":[
					{
						"property":"{{ n_ET0k2.outputs.result.authorization }}",
						"filter":{
							"operator":"EXISTS"
						}
					}
				],
				"operator":"AND"
			},
			"skip":false,
			"subTitle":"Condition",
			"title":"Condition",
			"type":"IF_ELSE"
		},
		{
			"context":{
				"appName":"code_by_unifyapps",
				"resourceVersion":0,
				"resourceName":"code_by_unifyapps_groovy",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"MANUAL",
			"groupId":"n_3E5R1@_6Puoh-1@y",
			"id":"n_7xsRp",
			"index":6,
			"inputs":{
				"output":{
					"type":"object",
					"additionalProperties":false,
					"properties":{
						"response":{
							"type":"object",
							"properties":{
								"keys":{
									"type":"array",
									"items":{
										"type":"object",
										"properties":{
											"kty":{
												"type":"string",
												"title":"kty"
											},
											"use":{
												"type":"string",
												"title":"use"
											},
											"kid":{
												"type":"string",
												"title":"kid"
											},
											"x5t":{
												"type":"string",
												"title":"x5t"
											},
											"n":{
												"type":"string",
												"title":"n"
											},
											"e":{
												"type":"string",
												"title":"e"
											},
											"x5c":{
												"type":"array",
												"items":{
													"type":"string"
												},
												"title":"x5c"
											},
											"cloud_instance_name":{
												"type":"string",
												"title":"cloud_instance_name"
											}
										},
										"additionalProperties":false
									},
									"title":"keys"
								}
							},
							"title":"response",
							"additionalProperties":false
						}
					}
				},
				"code":"import com.unifyapps.infra.utils.JsonUtils;\r\n\r\n\r\nString tenantId = \"0d85160c-5899-44ca-acc8-db1501b993b6\";\r\nString jwksUri = \"https://login.microsoftonline.com/\" + tenantId + \"/discovery/keys\";\r\n\r\n\r\nURL url = new URL(jwksUri);\r\nHttpURLConnection conn = (HttpURLConnection) url.openConnection();\r\nconn.setRequestMethod(\"GET\");\r\nconn.setRequestProperty(\"Accept\", \"application/json\");\r\n\r\nif (conn.getResponseCode() != 200) {\r\n    throw new RuntimeException(\"Failed : HTTP error code : \" + conn.getResponseCode());\r\n}\r\n\r\ntry (BufferedReader br = new BufferedReader(new InputStreamReader((conn.getInputStream())))) {\r\n    StringBuilder sb = new StringBuilder();\r\n    String output;\r\n    while ((output = br.readLine()) != null) {\r\n        sb.append(output);\r\n    }\r\n    if (sb != null) {\r\n        return Map.of(\"response\", JsonUtils.fromJson(sb.toString(), Map.class));\r\n    }\r\n} finally {\r\n    conn.disconnect();\r\n}\r\n\r\nreturn [\"response\":Map.of(\"keys\", List.of())];",
				"compile_static":false,
				"captureStdOutput":false
			},
			"options":{
				"bulkheadConfig":{
					"enabled":false,
					"maxLeaseTimeUnit":"SECONDS",
					"maxWaitDurationUnit":"SECONDS"
				},
				"businessHoursConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"cacheConfig":{
					"cacheKey":"{{ n_Sy0Hw.outputs.tenantId }}",
					"enabled":true,
					"timeToLive":"3600",
					"usagePolicy":"ALWAYS"
				},
				"circuitBreakerConfig":{
					"enabled":false
				},
				"disableLogging":false,
				"enabledForReExecution":false,
				"hookConfig":{
					"enabled":false,
					"postHooks":[
						
					],
					"preHooks":[
						
					]
				},
				"logConfig":{
					"enabled":false,
					"logPolicies":[
						
					]
				},
				"rateLimitConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"retryConfig":{
					"backOffFactor":null,
					"captureRetries":false,
					"enabled":false
				},
				"stepError":"MANUAL",
				"telemetryConfig":{
					"enableTelemetry":false,
					"metricConfigs":[
						
					]
				}
			},
			"skip":false,
			"subTitle":"Code by UnifyApps",
			"title":"Execute Groovy code",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":800,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_7xsRp@n_3E5R1@_6Puoh-1@y@error",
			"id":"_buXRg",
			"index":7,
			"inputs":{
				"result":{
					"response":{
						"response":"123456",
						"message":"JWT validation failed",
						"statusCode":401
					},
					"proceed":false
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		},
		{
			"context":{
				"appName":"code_by_unifyapps",
				"resourceVersion":807,
				"resourceName":"code_by_unifyapps_groovy",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"MANUAL",
			"groupId":"n_3E5R1@_6Puoh-1@y",
			"id":"n_NWFBG",
			"index":8,
			"inputs":{
				"output":{
					"type":"object",
					"additionalProperties":false,
					"properties":{
						"decoded":{
							"type":"object",
							"properties":{
								"aud":{
									"type":"string",
									"title":"aud"
								},
								"iss":{
									"type":"string",
									"title":"iss"
								},
								"iat":{
									"type":"integer",
									"title":"iat"
								},
								"nbf":{
									"type":"integer",
									"title":"nbf"
								},
								"exp":{
									"type":"integer",
									"title":"exp"
								},
								"aio":{
									"type":"string",
									"title":"aio"
								},
								"appid":{
									"type":"string",
									"title":"appid"
								},
								"appidacr":{
									"type":"string",
									"title":"appidacr"
								},
								"idp":{
									"type":"string",
									"title":"idp"
								},
								"oid":{
									"type":"string",
									"title":"oid"
								},
								"rh":{
									"type":"string",
									"title":"rh"
								},
								"sub":{
									"type":"string",
									"title":"sub"
								},
								"tid":{
									"type":"string",
									"title":"tid"
								},
								"uti":{
									"type":"string",
									"title":"uti"
								},
								"ver":{
									"type":"string",
									"title":"ver"
								},
								"xms_ftd":{
									"type":"string",
									"title":"xms_ftd"
								}
							},
							"title":"decoded",
							"additionalProperties":false
						}
					}
				},
				"input":{
					"type":"object",
					"additionalProperties":false,
					"required":[
						"token",
						"keys"
					],
					"properties":{
						"token":{
							"type":"string",
							"title":"Token"
						},
						"keys":{
							"type":"array",
							"items":{
								"type":"object",
								"properties":{},
								"additionalProperties":false
							},
							"title":"Keys"
						}
					}
				},
				"code":"import com.nimbusds.jose.JWSAlgorithm\nimport com.nimbusds.jose.jwk.JWK\nimport com.nimbusds.jose.jwk.JWKSet\nimport com.nimbusds.jose.jwk.RSAKey\nimport com.nimbusds.jwt.SignedJWT\nimport com.nimbusds.jose.proc.BadJWSException\n\ndef getSigningKey(keys, kid) {\n    def jwkSet = new JWKSet(keys.collect { JWK.parse(it) })\n    def key = jwkSet.getKeyByKeyId(kid)\n    if (key == null) {\n        throw new Exception(\"Key not found\")\n    }\n    return key\n}\n\ndef verifyToken(String token, List<Map> keys) {\n    def signedJWT = SignedJWT.parse(token)\n    def header = signedJWT.header\n    def kid = header.keyID\n\n    def key = getSigningKey(keys, kid)\n\n    if (!(key instanceof RSAKey)) {\n        throw new Exception(\"Unsupported key type: ${key.keyType}\")\n    }\n\n    def verifier = new com.nimbusds.jose.crypto.RSASSAVerifier(key.toRSAPublicKey())\n\n    if (!signedJWT.verify(verifier)) {\n        throw new Exception(\"Token signature verification failed\")\n    }\n\n    def claims = signedJWT.payload.toJSONObject()\n\n    // Optional expiration check\n    def exp = signedJWT.getJWTClaimsSet().getExpirationTime()\n    if (exp != null && exp.before(new Date())) {\n        throw new Exception(\"Token has expired\")\n    }\n\n    return claims\n}\n\n// Example usage\ntry {\n    def decoded = verifyToken(token, keys)  // 'token' is JWT string, 'keys' is List<Map> of JWKs\n    def result = [\"decoded\": decoded]\n    return result\n} catch (Exception e) {\n    def result = [\"error\": e.message]\n    return result\n}\n",
				"compile_static":false,
				"captureStdOutput":false,
				"parameters":{
					"token":"{{ n_ET0k2.outputs.result.authorization }}",
					"keys":{
						"ua:type":"mappedArray",
						"source":"{{ n_7xsRp.outputs.result.response.keys }}",
						"items":"{{ n_7xsRp.outputs.result.response.keys[0] }}"
					}
				}
			},
			"options":{
				"bulkheadConfig":{
					"enabled":false,
					"maxLeaseTimeUnit":"SECONDS",
					"maxWaitDurationUnit":"SECONDS"
				},
				"businessHoursConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"cacheConfig":{
					"enabled":false,
					"usagePolicy":"ALWAYS"
				},
				"circuitBreakerConfig":{
					"enabled":false
				},
				"disableLogging":true,
				"enabledForReExecution":false,
				"hookConfig":{
					"enabled":false,
					"postHooks":[
						
					],
					"preHooks":[
						
					]
				},
				"logConfig":{
					"enabled":false,
					"logPolicies":[
						
					]
				},
				"rateLimitConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"retryConfig":{
					"backOffFactor":null,
					"captureRetries":false,
					"enabled":false
				},
				"stepError":"MANUAL",
				"telemetryConfig":{
					"enableTelemetry":false,
					"metricConfigs":[
						
					]
				}
			},
			"skip":false,
			"subTitle":"Code by UnifyApps",
			"title":"Execute Groovy code",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":800,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_NWFBG@n_3E5R1@_6Puoh-1@y@error",
			"id":"_ykicF",
			"index":9,
			"inputs":{
				"result":{
					"response":{
						"response":"345678",
						"message":"JWT validation failed",
						"statusCode":401
					},
					"proceed":false
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		},
		{
			"context":{
				"appName":"if_else",
				"resourceVersion":5,
				"resourceName":"if_else_condition",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_3E5R1@_6Puoh-1@y",
			"id":"n_cJWiB",
			"index":10,
			"inputs":{
				"filters":[
					{
						"property":"{{ n_NWFBG.outputs.result.decoded.iss }}",
						"filter":{
							"operator":"EQUAL",
							"value":"https://sts.windows.net/0d85160c-5899-44ca-acc8-db1501b993b6/"
						}
					},
					{
						"filters":[
							{
								"property":"{{ n_NWFBG.outputs.result.decoded.aud }}",
								"filter":{
									"operator":"EQUAL",
									"value":"https://graph.microsoft.com/"
								}
							},
							{
								"property":"{{ n_NWFBG.outputs.result.decoded.aud }}",
								"filter":{
									"operator":"EQUAL",
									"value":"https://service.flow.microsoft.com/"
								}
							},
							{
								"property":"{{ n_NWFBG.outputs.result.decoded.aud }}",
								"filter":{
									"operator":"EQUAL",
									"value":"https://eagprod.crm5.dynamics.com/"
								}
							}
						],
						"operator":"OR"
					}
				],
				"operator":"AND"
			},
			"skip":false,
			"subTitle":"Condition",
			"title":"Condition",
			"type":"IF_ELSE"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":14,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_cJWiB@n_3E5R1@_6Puoh-1@y@y",
			"id":"n_q1A6h",
			"index":11,
			"inputs":{
				"result":{
					"response":{
						"headers":"{{ n_olwxh.outputs.response.headers }}",
						"message":"{{ n_olwxh.outputs.response.message }}",
						"response":"{{ n_olwxh.outputs.response.response }}",
						"statusCode":"{{ n_olwxh.outputs.response.statusCode }}"
					},
					"request":{
						"path":"{{ n_olwxh.outputs.request.path }}",
						"requestHeaders":"{{ n_olwxh.outputs.request.requestHeaders }}",
						"pathParams":"{{ n_olwxh.outputs.request.pathParams }}",
						"queryParams":"{{ n_olwxh.outputs.request.queryParams }}",
						"httpMethod":"{{ n_olwxh.outputs.request.httpMethod }}",
						"payload":"{{ n_olwxh.outputs.request.payload }}"
					},
					"proceed":true
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":800,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_cJWiB@n_3E5R1@_6Puoh-1@y@n",
			"id":"_GOWnv",
			"index":12,
			"inputs":{
				"result":{
					"response":{
						"response":"{{ n_NWFBG.outputs.result.decoded }}",
						"message":"JWT validation failed- {{ n_NWFBG.outputs.result.decoded.aud }}-{{ n_NWFBG.outputs.result.decoded.iss }}",
						"statusCode":401
					},
					"proceed":false
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":5,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_3E5R1@_6Puoh-1@n",
			"id":"n_9hMgd",
			"index":13,
			"inputs":{
				"result":{
					"response":{
						"response":"123456",
						"message":"JWT Validation Failed",
						"statusCode":401
					},
					"proceed":false
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		}
	],
	"ownerUserId":161958,
	"schemaReferences":[
		
	],
	"settings":{
		"enableNodeLevelLogging":true,
		"enableRunLogging":true,
		"enableVariableLogging":true,
		"route":{
			"default":false,
			"tierName":"global"
		}
	},
	"standard":false,
	"tags":[
		
	],
	"version":1
}